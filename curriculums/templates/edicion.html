<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Currículum</title>
    <link rel="stylesheet" href="{{ url_for('curriculums.static', filename='css/edicion.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/colors.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/menu.css') }}">
</head>
<body>

{% include 'menu.html' %}

<div class="buttons-bar">
    <div class="buttons-left">
        <a href="{{ url_for('curriculums.home') }}">
            <button class="back-button">Regresar</button>
        </a>
    </div>
    <div class="buttons-right">
        <button class="guardar" onclick="saveToJson()">Guardar</button>
        <button id="compilar-btn" onclick="compilar()">Compilar</button> <!--  -->
        <a href="{{ url_for('curriculums.exportar', id_curriculum=id) }}">
            <button>Exportar</button>
        </a>
        <button id="eliminar-btn" onclick="eliminarCurriculum()">Eliminar</button>
        <button id="togglePreview" onclick="togglePreview()">→</button> <!--  -->
    </div>
</div>

<div class="container">
    <div class="form-container">
        <div class="form-panel" id="personal-info">
            <div class="form-header" onclick="toggleSection('personal-info')">
                Datos Personales
                <span>▲</span>
            </div>
            <div class="form-body">
                <input type="text" name="nombre"" id="name" placeholder="Nombre(s)" value="{{ cv.datos_personales.nombre if cv.datos_personales else '' }}" required>
                <input type="text" name="apellidos" id="surname" placeholder="Apellidos" value="{{ cv.datos_personales.apellidos if cv.datos_personales else '' }}" required>
                <input type="text" name="ocupacion" id="ocupacion" placeholder="Ocupación" value="{{ cv.datos_personales.ocupacion if cv.datos_personales else '' }}">
                <label for="nacimiento">Fecha de nacimiento</label>
                <input type="date" name="fecha_nacimiento" class="custom-date" id="nacimiento" value="{{ cv.datos_personales.fecha_nacimiento if cv.datos_personales else '' }}">
                <input type="tel" name="telefono" id="phone" placeholder="Teléfono" value="{{ cv.datos_personales.telefono if cv.datos_personales else '' }}">
                <input type="email" name="email" id="email" placeholder="Correo electrónico" value="{{ cv.datos_personales.email if cv.datos_personales else '' }}">
            </div>
        </div>

        <!-- Seccion de experiencias laborales -->
        <div class="seccion" id="experienciasLaborales">
        </div>
        <button type="button" class="agregarCampo" id="agregarExperiencia">Añadir trabajo</button>

        <!-- Seccion de educacion-->
        <div class="seccion" id="seccionEducacion">
        </div>
        <button type="button" class="agregarCampo" id="agregarEducacion">Añadir educacion</button>

        <!-- Seccion de habilidades-->
        <div class="seccion" id="seccionHabilidad">
        </div>
        <button type="button" class="agregarCampo" id="agregarHabilidad">Añadir habilidad</button>

        <!-- seccion de idiomas -->
        <div class="form-panel" id="lenguaje-info">
            <div class="form-header" onclick="toggleSection('lenguaje-info')">
                Idioma
                <span>▲</span>
            </div> 
            <div class="form-body">
                <input type="text" id="language" placeholder="Idioma" value="{{ cv.lenguajes[0].idioma if cv.lenguajes else '' }}">
                <input type="text" id="language-level" placeholder="Nivel" value="{{ cv.lenguajes[0].nivel if cv.lenguajes else '' }}">
            </div>
        </div>
        <div class="form-panel" id="links-info">
            <div class="form-header" onclick="toggleSection('links-info')">
                Links
                <span>▲</span>
            </div>
            <div class="form-body">
                <input type="text" id="link-nombre" placeholder="Nombre" value="{{ cv.links[0].nombre if cv.links else '' }}">
                <input type="text" id="link" placeholder="Link" value="{{ cv.links[0].link if cv.links else '' }}">
            </div>
        </div>
    </div>
    <div class="preview-panel" id="previewPanel">
        <!-- Aquí se muestra la vista previa del CV -->
        <!-- <iframe id="pdfFrame" src="{{ url_for('curriculums.previsualizar', id_curriculum=id) }}" frameborder="0"></iframe> -->
        <iframe id="pdfFrame" src="" frameborder="0"></iframe>
    </div>
</div>

<script>
    // cargar datos del json
    const datosCurriculum = {{ cv|tojson }};
    datosCurriculum.experiencia_laboral.forEach((experiencia, index) => {
        const nuevaExperiencia = `
            <div class="form-panel" id="job-experience-${index+1}">
                <div class="form-header" onclick="toggleSection('job-experience-${index+1}')">
                    Experiencia Laboral
                    <span>▲</span>
                </div>
                <div class="eliminar" onclick="eliminarSeccion('job-experience-${index+1}')">
                    <span>X</span>
                </div>
                <div class="form-body">
                    <input type="text" name="compania" id="company" placeholder="Compañía" value="${experiencia.compania}">
                    <input type="text" name="puesto" id="job-title" placeholder="Puesto" value="${experiencia.puesto}">
                    <label for="job-start-date">Fecha de inicio</label>
                    <input type="date" name="fecha_inicio" class="custom-date" id="job-start-date" value="${experiencia.fecha_inicio}">
                    <label for="job-end-date">Fecha de finalización</label>
                    <input type="date" name="fecha_fin" class="custom-date" id="job-end-date" value="${experiencia.fecha_fin}">
                    <textarea id="job-summary" name="resumen" placeholder="Tarea / Resumen">${experiencia.resumen}</textarea>
                </div>
            </div>
        `;
        document.getElementById('experienciasLaborales').insertAdjacentHTML('beforeend', nuevaExperiencia);
    });
    datosCurriculum.educacion.forEach((educacion, index) => {
        const nuevaEducacion = `
            <div class="form-panel" id="education-info-${index+1}">
                <div class="form-header" onclick="toggleSection('education-info-${index+1}')">
                    Educación
                    <span>▲</span>
                </div>
                <div class="eliminar" onclick="eliminarSeccion('education-info-${index+1}')">
                    <span>X</span>
                </div>
                <div class="form-body">
                    <input type="text" name="institucion" id="institution" placeholder="Institución" value="${educacion.institucion}">
                    <input type="text" name="grado" id="degree" placeholder="Carrera" value="${educacion.grado}">
                    <label for="educacion-start-date">Fecha de inicio</label>
                    <input type="date" name="fecha_inicio" class="custom-date" id="education-start-date" value="${educacion.fecha_inicio}">
                    <label for="educacion-end-date">Fecha de finalización</label>
                    <input type="date" name="fecha_fin" class="custom-date" id="education-end-date" value="${educacion.fecha_fin}">
                    <textarea name="resumen" id="education-description" placeholder="Descripción">${educacion.resumen}</textarea>
                </div>
            </div>
        `;
        document.getElementById('seccionEducacion').insertAdjacentHTML('beforeend', nuevaEducacion);
    });
    datosCurriculum.habilidades.forEach((habilidad, index) => {
        const nuevaHabilidad = `
            <div class="form-panel" id="habilidad-info-${index+1}">
                <div class="form-header" onclick="toggleSection('habilidad-info-${index+1}')">
                    Habilidades
                    <span>▲</span>
                </div>
                <div class="eliminar" onclick="eliminarSeccion('habilidad-info-${index+1}')">
                    <span>X</span>
                </div>
                <div class="form-body">
                    <input type="text" name="nombre" id="skill" placeholder="Habilidad" value="${habilidad.nombre}">
                    <input type="text" name="resumen" id="skill-description" placeholder="Descripción" value="${habilidad.resumen}">
                </div>
            </div>
        `;
        document.getElementById('seccionHabilidad').insertAdjacentHTML('beforeend', nuevaHabilidad);
    });


    // crear nuevos campo de secciones
    let contadorExperiencia = 1;
    document.getElementById('agregarExperiencia').addEventListener('click', function() {
        contadorExperiencia++;
        const nuevaExperiencia = `
            <div class="form-panel" id="job-experience-${contadorExperiencia}">
                <div class="form-header" onclick="toggleSection('job-experience-${contadorExperiencia}')">
                    Experiencia Laboral
                    <span>▲</span>
                </div>
                <div class="eliminar" onclick="eliminarSeccion('job-experience-${contadorExperiencia}')">
                    <span>X</span>
                </div>
                <div class="form-body">
                    <input type="text" name="compania" id="company" placeholder="Compañía" value="">
                    <input type="text" name="puesto" id="job-title" placeholder="Puesto" value="">
                    <label for="job-start-date">Fecha de inicio</label>
                    <input type="date" name="fecha_inicio" class="custom-date" id="job-start-date" value="">
                    <label for="job-end-date">Fecha de finalización</label>
                    <input type="date" name="fecha_fin" class="custom-date" id="job-end-date" value="">
                    <textarea id="job-summary" name="resumen" placeholder="Tarea / Resumen"></textarea>
                </div>
            </div>
        `;
        document.getElementById('experienciasLaborales').insertAdjacentHTML('beforeend', nuevaExperiencia);
    });
    let contadorEducacion = 1;
    document.getElementById('agregarEducacion').addEventListener('click', function() {
        contadorEducacion++;
        const nuevaEducacion = `
            <div class="form-panel" id="education-info-${contadorEducacion}">
                <div class="form-header" onclick="toggleSection('education-info-${contadorEducacion}')">
                    Educación
                    <span>▲</span>
                </div>
                <div class="eliminar" onclick="eliminarSeccion('education-info-${contadorEducacion}')">
                    <span>X</span>
                </div>
                <div class="form-body">
                    <input type="text" name="institucion" id="institution" placeholder="Institución" value="">
                    <input type="text" name="grado" id="degree" placeholder="Carrera" value="">
                    <label for="educacion-start-date">Fecha de inicio</label>
                    <input type="date" name="fecha_inicio" class="custom-date" id="education-start-date" value="">
                    <label for="educacion-end-date">Fecha de finalización</label>
                    <input type="date" name="fecha_fin" class="custom-date" id="education-end-date" value="">
                    <textarea name="resumen" id="education- description" placeholder="Descripción"></textarea>
                </div>
            </div>
        `;
        document.getElementById('seccionEducacion').insertAdjacentHTML('beforeend', nuevaEducacion);
    });
    let contadorHabilidad = 1;
    document.getElementById('agregarHabilidad').addEventListener('click', function() {
        contadorHabilidad++;
        const nuevaHabilidad = `
            <div class="form-panel" id="habilidad-info-${contadorHabilidad}">
                <div class="form-header" onclick="toggleSection('habilidad-info-${contadorHabilidad}')">
                    Habilidades
                    <span>▲</span>
                </div>
                <div class="eliminar" onclick="eliminarSeccion('habilidad-info-${contadorHabilidad}')">
                    <span>X</span>
                </div>
                <div class="form-body">
                    <input type="text" name="nombre" id="skill" placeholder="Habilidad" value="">
                    <input type="text" name="resumen" id="skill-description" placeholder="Descripción" value="">
                </div>
            </div>
        `;
        document.getElementById('seccionHabilidad').insertAdjacentHTML('beforeend', nuevaHabilidad);
    });

    function eliminarSeccion(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
            section.remove()
        }
    }

    function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        const formBody = section.querySelector('.form-body');
        const icon = section.querySelector('span');

        // Alternar la clase 'minimized'
        if (section.classList.contains('minimized')) {
            section.classList.remove('minimized');
            formBody.style.display = 'block'; // Mostrar el contenido del formulario
            icon.textContent = '▲'; // Cambiar el icono a la flecha hacia abajo
        } else {
            section.classList.add('minimized');
            formBody.style.display = 'none'; // Ocultar el contenido del formulario
            icon.textContent = '▼'; // Cambiar el icono a la flecha hacia arriba
        }
    }
    function togglePreview() {
        const toggleButton = document.getElementById('togglePreview');
        const previewPanel = document.getElementById('previewPanel');

        // Alternar la clase 'minimized'
        if(previewPanel.style.display === 'none'){
            previewPanel.style.display = 'block'; // Mostrar el panel
            toggleButton.textContent = '→'; // Cambiar el texto del botón
        } else {
            previewPanel.style.display = 'none'; // Ocultar el panel
            toggleButton.textContent = '←'; // Cambiar el texto del botón
        }
    }
    function saveToJson() {
        const datosPersonales = {}
        document.querySelectorAll('#personal-info input').forEach(input => {
            datosPersonales[input.name] = input.value;
        });
        const experienciasLaborales = [];
        document.querySelectorAll('#experienciasLaborales .form-panel').forEach(experiencia => {
            const campos = {};
            experiencia.querySelectorAll('input, textarea').forEach(input => {
                campos[input.name] = input.value;
            });
            experienciasLaborales.push(campos);
        });
        const seccionEducacion = [];
        document.querySelectorAll('#seccionEducacion .form-panel').forEach(educacion => {
            const campos = {};
            educacion.querySelectorAll('input, textarea').forEach(input => {
                campos[input.name] = input.value;
            });
            seccionEducacion.push(campos);
        });
        const seccionHabilidad = [];
        document.querySelectorAll('#seccionHabilidad .form-panel').forEach(habilidad => {
            const campos = {};
            habilidad.querySelectorAll('input, textarea').forEach(input => {
                campos[input.name] = input.value;
            });
            seccionHabilidad.push(campos);
        });

        // Recoger datos de los formularios
        const data = {
            datos_personales: datosPersonales,
            links: [
                {
                    nombre: document.getElementById('link-nombre').value,
                    link: document.getElementById('link').value
                }
            ],
            lenguajes: [
                {
                    idioma: document.getElementById('language').value,
                    nivel: document.getElementById('language-level').value
                }
            ],
            habilidades: seccionHabilidad,
            experiencia_laboral: experienciasLaborales,
            educacion: seccionEducacion
        };
        // Convertir a JSON
        const jsonData = JSON.stringify(data);

        fetch('/curriculums/editar/{{ id }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: jsonData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status == "success") {
                alert(data.message);
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error', error);
        });
    }
    function compilar() {
        const url = "{{ url_for('curriculums.previsualizar', id_curriculum=id) }}";
        // Actualizar el src del iframe con la nueva URL
        document.getElementById('pdfFrame').src = url;
    }
    function eliminarCurriculum() {
        if (confirm("¿Estás seguro de que deseas eliminar este currículum? Esta acción no se puede deshacer.")) {
            // Enviar la solicitud de eliminación al servidor
            // fetch('/curriculums/eliminar/{{ id }}', {
            fetch("{{ url_for('curriculums.eliminar', id_curriculum=id) }}", {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status == "success") {
                    alert(data.message);
                    window.location.href = "{{ url_for('curriculums.home') }}"; // Redirigir después de eliminar
                } else {
                    alert("Error al eliminar: " + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ocurrió un error al intentar eliminar el currículum.');
            });
        }
    }
</script>

</body>
</html>